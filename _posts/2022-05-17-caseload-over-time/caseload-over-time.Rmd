---
title: "Caseload over time"
description: |
  How to count open referrals in a given period of time.
author:
  - name: ZoÃ« Turner
    url:
      https://twitter.com/letxuga007: {}
date: 2022-05-17
output:
  distill::distill_article:
    self_contained: false
categories:
  - Open source
  - GitHub
preview: img/a_text_book_of_mineralogy.jpg
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = FALSE)
```

Finding open referrals now is reasonably easy, it will be to look for where there is no date/time in discharges. However, if we need the open referrals last month, some of those referrals may be been closed since then.

A really nice graphic that illustrates the logic required to consider referrals (or other things) in a given period of time is this:

![Screenshot of a 6 patient scenarios graphically shown and explained in text below](img/caseload.png)

This is an image taken from the [AphA website](https://www.aphanalysts.org/wp-content/uploads/2016/08/JOIS_2016_038_Diagnosing_the_Flow_Constraint_i.pdf) but has since been moved sadly and details of the original authors lost. If you are the original owner or know who did this please do get in touch with an [issue](https://github.com/CDU-data-science-team/team-blog/issues) or [email](mailto:cduDataScience@nottshc.nhs.uk).

To explain the diagram:
`Patient one` had an open referral that was closed before the time we are counting.
`Patient two` had a open referral that closed in the time period.
`Patient three` had an open and closed referral within the time period.
`Patient four` started with a referral in the time period but ended afterwards.
`Patient five` started and ended after the time period.
`Patient six` started before and ended after the time period.

Open referrals to count are therefore include Patient 2, Patient 3, Patient 4 and Patient 6.
 
# Using R

This can be recreated in R using dplyr but note that the functions used can be slow for many rows. It can be hard to filter the dates, particularly in Mental Health, as some referrals are open over many years and we need to include those patients 2 and 6 - who had an open referral start before the time period.

```{r}
caseload <- referrals %>%
  # Ensure dates are in date format, sometimes they get changed when imported 
  #from SQL, particularly date format (not so much datetime)
  
  # Using lubridate::today() where a discharge date is not entered (still open) 
  #makes this easier to work with dates in later code
  dplyr::mutate(
    referral_date = as.Date(referrals_referral_datetime),
    discharge_date = as.Date(referrals_discharge_datetime),
    discharge_date = case_when(is.na(discharge_date) ~ lubridate::today(),
                               TRUE ~ discharge_date)) %>%
  dplyr:: select(patient,
                 referral,
                 team,
                 referral_date,
                 discharge_date
  ) %>%
  dplyr::group_by(patient,
                  referral,
                  team) %>%
  # Pivot to tidy data (long)
  tidyr::pivot_longer(cols = ends_with("Date"),
                      names_to = "caseload",
                      values_to = "dates") %>% 
  dplyr::ungroup() # good practice to ungroup as can affect counts later

# complete() fills in the date sequence so 20200101 to 20200103 will now have a 
#line for dates 01, 02 and 03
fill_dates <- caseload %>%
  tidyr::complete(dates = seq.Date(min(dates), max(dates), by = "day")) 

# counting distinct patients
caseload_counts <- fill_dates %>%
  # although the dataset is now each day has a row, this is a count by month
  dplyr::mutate(month = lubridate::floor_date(dates, unit = "month")) %>% 
  dplyr::group_by(team,
                  month) %>%
  summarise(count_distinct_patients = n_distinct(client_id))

```

